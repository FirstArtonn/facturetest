<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>G√©n√©rateur de Factures Moderne</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@300;400;600;700&family=Outfit:wght@300;400;500;600;700&family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
<style>
:root {
  --color-primary: #1a1a2e;
  --color-secondary: #16213e;
  --color-accent: #0f3460;
  --color-highlight: #e94560;
  --color-gold: #d4af37;
  --color-bg: #0a0a12;
  --color-surface: #1a1a2e;
  --color-text: #e8e8e8;
  --color-text-dim: #a0a0a8;
  --color-border: #2a2a3e;
}

[data-theme="light"] {
  --color-primary: #f8fafc;
  --color-secondary: #e2e8f0;
  --color-accent: #cbd5e1;
  --color-highlight: #6366f1;
  --color-gold: #8b5cf6;
  --color-bg: #ffffff;
  --color-surface: #f8fafc;
  --color-text: #0f172a;
  --color-text-dim: #64748b;
  --color-border: #e2e8f0;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

/* Smooth transitions for theme switching */
body, .form-panel, .preview-panel, .custom-input, header {
  transition: background 0.3s ease, color 0.3s ease, border-color 0.3s ease;
}

/* Theme Toggle Switch */
.theme-toggle-wrapper {
  display: flex;
  align-items: center;
  gap: 1rem;
}

.theme-switch {
  position: relative;
  width: 60px;
  height: 30px;
  background: var(--color-border);
  border-radius: 15px;
  cursor: pointer;
  transition: background 0.3s ease;
}

.theme-switch:hover {
  background: var(--color-highlight);
}

.theme-slider {
  position: absolute;
  top: 3px;
  left: 3px;
  width: 24px;
  height: 24px;
  background: white;
  border-radius: 50%;
  transition: transform 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 4px rgba(0,0,0,0.2);
}

[data-theme="light"] .theme-slider {
  transform: translateX(30px);
}

.theme-icon {
  font-size: 14px;
}

body {
  font-family: 'Outfit', sans-serif;
  background: linear-gradient(135deg, var(--color-bg) 0%, var(--color-secondary) 100%);
  color: var(--color-text);
  min-height: 100vh;
  padding: 2rem;
  position: relative;
  overflow-x: hidden;
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-image: 
    radial-gradient(circle at 20% 50%, rgba(233, 69, 96, 0.1) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(15, 52, 96, 0.15) 0%, transparent 50%);
  pointer-events: none;
  z-index: 0;
  transition: opacity 0.3s ease;
}

[data-theme="light"] body::before {
  background-image: 
    radial-gradient(circle at 20% 50%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
    radial-gradient(circle at 80% 80%, rgba(139, 92, 246, 0.1) 0%, transparent 50%);
}

.container {
  max-width: 1400px;
  margin: 0 auto;
  position: relative;
  z-index: 1;
}

header {
  text-align: center;
  margin-bottom: 3rem;
  animation: fadeInDown 0.8s ease-out;
  padding: 2rem 2rem 1rem 2rem;
  background: rgba(26, 26, 46, 0.3);
  backdrop-filter: blur(20px);
  border-radius: 24px;
  border: 1px solid var(--color-border);
}

[data-theme="light"] header {
  background: rgba(248, 250, 252, 0.8);
}

h1 {
  font-family: Impact, 'Arial Black', sans-serif;
  font-size: 4.5rem;
  font-weight: 400;
  background: linear-gradient(135deg, var(--color-gold) 0%, var(--color-highlight) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 0.5rem;
  letter-spacing: 0.02em;
  line-height: 1;
  text-transform: uppercase;
}

[data-theme="light"] h1 {
  background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.subtitle {
  font-size: 1.2rem;
  color: var(--color-text-dim);
  font-weight: 400;
  letter-spacing: 0.08em;
  text-transform: uppercase;
}

.main-grid {
  display: grid;
  grid-template-columns: 450px 1fr;
  gap: 2rem;
  animation: fadeIn 1s ease-out 0.2s both;
}

.form-panel {
  background: rgba(26, 26, 46, 0.8);
  backdrop-filter: blur(30px);
  border: 1px solid var(--color-border);
  border-radius: 24px;
  padding: 2.5rem;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6), 0 0 0 1px rgba(255, 255, 255, 0.05) inset;
  height: fit-content;
  position: sticky;
  top: 2rem;
}

[data-theme="light"] .form-panel {
  background: rgba(255, 255, 255, 0.9);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(0, 0, 0, 0.05) inset;
}

.form-section {
  margin-bottom: 2rem;
}

.form-section:last-child {
  margin-bottom: 0;
}

.section-title {
  font-family: Impact, 'Arial Black', sans-serif;
  font-size: 1.8rem;
  font-weight: 400;
  color: var(--color-gold);
  margin-bottom: 1.5rem;
  padding-bottom: 0.8rem;
  border-bottom: 2px solid var(--color-border);
  letter-spacing: 0.05em;
  text-transform: uppercase;
}

[data-theme="light"] .section-title {
  color: #6366f1;
}

.input-group {
  margin-bottom: 1.2rem;
  position: relative;
}

label {
  display: block;
  font-size: 0.85rem;
  font-weight: 500;
  color: var(--color-text-dim);
  margin-bottom: 0.5rem;
  text-transform: uppercase;
  letter-spacing: 0.1em;
}

.custom-input {
  width: 100%;
  padding: 1rem 1.3rem;
  background: rgba(15, 52, 96, 0.25);
  border: 1px solid var(--color-border);
  border-radius: 12px;
  color: var(--color-text);
  font-family: 'Outfit', sans-serif;
  font-size: 1rem;
  transition: all 0.3s ease;
  outline: none;
}

.custom-input:focus {
  border-color: var(--color-highlight);
  background: rgba(15, 52, 96, 0.35);
  box-shadow: 0 0 0 4px rgba(233, 69, 96, 0.15);
}

[data-theme="light"] .custom-input {
  background: rgba(99, 102, 241, 0.05);
  border-color: var(--color-border);
}

[data-theme="light"] .custom-input:focus {
  border-color: #6366f1;
  background: rgba(99, 102, 241, 0.08);
  box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
}

.custom-input::placeholder {
  color: rgba(160, 160, 168, 0.5);
}

input[type="file"].custom-input {
  padding: 0.6rem;
  cursor: pointer;
}

input[type="file"].custom-input::file-selector-button {
  padding: 0.5rem 1rem;
  background: var(--color-highlight);
  color: white;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-family: 'Outfit', sans-serif;
  font-weight: 600;
  margin-right: 1rem;
  transition: all 0.3s ease;
}

input[type="file"].custom-input::file-selector-button:hover {
  background: #c83653;
  transform: translateY(-1px);
}

.reason-line {
  display: grid;
  grid-template-columns: 1fr 80px 100px 40px;
  gap: 0.6rem;
  margin-bottom: 0.8rem;
  align-items: end;
}

.reason-line input {
  padding: 1rem 1.2rem;
  font-size: 1rem;
  font-weight: 500;
}

.reason-line input:first-child {
  font-size: 1.05rem;
  font-weight: 600;
  color: var(--color-text);
}

.btn {
  padding: 1rem 2rem;
  border: none;
  border-radius: 12px;
  font-family: 'Outfit', sans-serif;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  width: 100%;
}

.btn-primary {
  background: linear-gradient(135deg, #d14561 0%, #b93650 100%);
  color: white;
  box-shadow: 0 4px 12px rgba(209, 69, 97, 0.2);
}

.btn-primary:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(209, 69, 97, 0.25);
  background: linear-gradient(135deg, #e94560 0%, #c83653 100%);
}

[data-theme="light"] .btn-primary {
  background: linear-gradient(135deg, #6b70d4 0%, #7b82e0 100%);
  box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
}

[data-theme="light"] .btn-primary:hover {
  box-shadow: 0 6px 16px rgba(99, 102, 241, 0.2);
  background: linear-gradient(135deg, #6366f1 0%, #8b8ff6 100%);
}

.btn-secondary {
  background: rgba(15, 52, 96, 0.25);
  color: var(--color-text);
  border: 1px solid var(--color-border);
  margin-top: 0.5rem;
}

.btn-secondary:hover {
  background: rgba(15, 52, 96, 0.35);
  border-color: rgba(209, 69, 97, 0.5);
}

[data-theme="light"] .btn-secondary {
  background: rgba(99, 102, 241, 0.05);
  border: 1px solid rgba(99, 102, 241, 0.2);
}

[data-theme="light"] .btn-secondary:hover {
  background: rgba(99, 102, 241, 0.1);
  border-color: rgba(99, 102, 241, 0.3);
}

.btn-icon {
  background: rgba(233, 69, 96, 0.1);
  border: 1px solid var(--color-highlight);
  color: var(--color-highlight);
  width: 40px;
  height: 40px;
  padding: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.2rem;
  transition: all 0.3s ease;
}

.btn-icon:hover {
  background: var(--color-highlight);
  color: white;
  transform: rotate(90deg);
}

.btn-remove {
  background: rgba(255, 68, 68, 0.1);
  border: 1px solid rgba(255, 68, 68, 0.3);
  color: #ff4444;
}

.btn-remove:hover {
  background: #ff4444;
  color: white;
  transform: scale(1.05) rotate(0deg);
}

.invoice-number-badge {
  margin-top: 1rem;
  padding: 0.8rem;
  background: rgba(212, 175, 55, 0.1);
  border-radius: 8px;
  text-align: center;
  font-size: 0.9rem;
  color: var(--color-gold);
  border: 1px solid rgba(212, 175, 55, 0.2);
}

[data-theme="light"] .invoice-number-badge {
  background: rgba(99, 102, 241, 0.08);
  color: #6366f1;
  border: 1px solid rgba(99, 102, 241, 0.2);
}

[data-theme="light"] .invoice-number-badge strong {
  color: #4f46e5;
}

.preview-panel {
  background: rgba(26, 26, 46, 0.5);
  backdrop-filter: blur(20px);
  border: 1px solid var(--color-border);
  border-radius: 24px;
  padding: 2.5rem;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
}

[data-theme="light"] .preview-panel {
  background: rgba(255, 255, 255, 0.7);
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
}

.preview-controls {
  display: flex;
  gap: 1rem;
  margin-bottom: 1.5rem;
}

.preview-controls .btn {
  width: auto;
  flex: 1;
}

#invoice-preview-wrap {
  width: 794px;
  height: 1123px;
  margin: 0 auto;
  border-radius: 16px;
  overflow: hidden;
  position: relative;
  background: white;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.7);
  transform-origin: top center;
}

[data-theme="light"] #invoice-preview-wrap {
  box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
}

.invoice-bg {
  position: absolute;
  inset: 0;
  z-index: 0;
  background-size: cover;
  background-position: center;
  opacity: 1;
  background-image: url("https://firstartonn.github.io/facturetest/Facture%20Paleto%20Garage%20(63).png");
}

.draggable {
  position: absolute;
  cursor: move;
  user-select: none;
  z-index: 10;
  color: #111;
  font-family: Arial, sans-serif;
  font-size: 16px;
  font-weight: 500;
  background: rgba(255, 255, 255, 0.001);
  min-width: 120px;
  text-align: left;
  white-space: pre-line;
  padding: 2px 4px;
  box-sizing: border-box;
  transition: all 0.2s ease;
}

.draggable > span {
  display: block;
  width: 100%;
  word-break: break-word;
  white-space: pre-line;
}

.draggable:hover {
  outline: 2px dashed var(--color-highlight);
  background: rgba(233, 69, 96, 0.05);
}

.draggable.selected {
  outline: 2px solid var(--color-highlight);
  background: rgba(233, 69, 96, 0.1);
  box-shadow: 0 0 20px rgba(233, 69, 96, 0.3);
}

/* Style sp√©cifique pour le num√©ro de facture */
#txtNumeroFacture {
  font-family: 'Roboto', sans-serif;
  font-size: 31.8px;
  font-weight: 700;
}

.autocomplete-list {
  position: absolute;
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  z-index: 1000;
  display: none;
  max-height: 200px;
  overflow-y: auto;
  backdrop-filter: blur(20px);
  margin-top: 4px;
}

.autocomplete-list div {
  padding: 0.8rem 1.2rem;
  cursor: pointer;
  transition: all 0.2s ease;
  border-bottom: 1px solid var(--color-border);
}

.autocomplete-list div:last-child {
  border-bottom: none;
}

.autocomplete-list div:hover {
  background: var(--color-highlight);
  color: white;
}

.context-menu {
  position: absolute;
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: 12px;
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
  display: none;
  z-index: 2000;
  min-width: 220px;
  overflow: hidden;
  backdrop-filter: blur(20px);
}

.context-menu div {
  padding: 0.9rem 1.2rem;
  cursor: pointer;
  transition: all 0.2s ease;
  border-bottom: 1px solid var(--color-border);
  font-size: 0.9rem;
}

.context-menu div:last-child {
  border-bottom: none;
}

.context-menu div:hover {
  background: var(--color-highlight);
  color: white;
}

.help-text {
  font-size: 0.8rem;
  color: var(--color-text-dim);
  margin-top: 1.5rem;
  padding: 1rem;
  background: rgba(15, 52, 96, 0.2);
  border-radius: 8px;
  border-left: 3px solid var(--color-gold);
  line-height: 1.6;
}

.help-text strong {
  color: var(--color-gold);
}

.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  z-index: 10000;
  justify-content: center;
  align-items: center;
}

.modal-content {
  background: var(--color-surface);
  padding: 2rem;
  border-radius: 16px;
  border: 1px solid var(--color-border);
  max-width: 500px;
  text-align: center;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.7);
}

.modal-content h2 {
  font-family: 'Cormorant Garamond', serif;
  color: var(--color-gold);
  margin-bottom: 1rem;
  font-size: 2rem;
}

.modal-content p {
  margin-bottom: 1.5rem;
  line-height: 1.6;
}

.auto-fill-badge {
  color: var(--color-gold);
  font-size: 0.75rem;
  display: none;
  margin-left: 0.5rem;
  animation: fadeIn 0.3s ease;
}

.config-banner {
  background: rgba(212, 175, 55, 0.1);
  border: 2px solid var(--color-gold);
  border-radius: 12px;
  padding: 1rem;
  margin-bottom: 2rem;
  text-align: center;
}

.config-banner strong {
  color: var(--color-gold);
}

@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeInDown {
  from {
    opacity: 0;
    transform: translateY(-30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

.spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--color-border);
  border-top-color: var(--color-highlight);
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin: 1rem auto;
}

@media (max-width: 1200px) {
  .main-grid {
    grid-template-columns: 1fr;
  }
  
  .form-panel {
    position: relative;
    top: 0;
  }
  
  #invoice-preview-wrap {
    transform: scale(0.8);
    transform-origin: top center;
  }
}

::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: var(--color-surface);
}

::-webkit-scrollbar-thumb {
  background: var(--color-accent);
  border-radius: 4px;
}

::-webkit-scrollbar-thumb:hover {
  background: var(--color-highlight);
}
</style>
</head>
<body>

<div class="container">
  <header>
    <div style="display: flex; justify-content: space-between; align-items: center;">
      <div style="flex: 1;">
        <h1>G√©n√©rateur de Factures</h1>
        <p class="subtitle">Cr√©ez des factures professionnelles en quelques clics</p>
      </div>
      <div class="theme-toggle-wrapper">
        <span style="font-size: 0.85rem; color: var(--color-text-dim); font-weight: 500;">Mode sombre</span>
        <div class="theme-switch" onclick="toggleTheme()">
          <div class="theme-slider">
            <span class="theme-icon" id="themeIcon">üåô</span>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Banni√®re de configuration -->
  <div class="config-banner" id="configBanner">
    <strong>‚öôÔ∏è Configuration requise :</strong> Veuillez renseigner votre ID Google Sheets dans le code (ligne ~660)
  </div>

  <div class="main-grid">
    <!-- Panneau de formulaire -->
    <div class="form-panel">
      <div class="form-section">
        <h2 class="section-title">Informations</h2>
        
        <div class="input-group">
          <label for="entreprise">Nom de l'entreprise</label>
          <input id="entreprise" class="custom-input" placeholder="Commencez √† taper..." autocomplete="off">
          <div id="entrepriseList" class="autocomplete-list"></div>
        </div>

        <div class="input-group">
          <label for="compte">
            Compte 
            <span id="compteAutoFill" class="auto-fill-badge">‚ú® Rempli automatiquement</span>
          </label>
          <input id="compte" class="custom-input" placeholder="Auto-rempli selon l'entreprise..." autocomplete="off">
          <div id="compteList" class="autocomplete-list"></div>
        </div>

        <div class="input-group">
          <label for="contrat">Type de contrat</label>
          <input id="contrat" class="custom-input" placeholder="Commencez √† taper..." autocomplete="off">
          <div id="contratList" class="autocomplete-list"></div>
        </div>
      </div>



      <div class="form-section">
        <h2 class="section-title">D√©tails de facturation</h2>
        <div id="reasons-container"></div>
        <button type="button" class="btn btn-secondary" onclick="addReason()">
          ‚ûï Ajouter une ligne
        </button>
      </div>

      <div class="form-section">
        <button class="btn btn-primary" onclick="downloadInvoiceImage()">
          üì• T√©l√©charger PNG
        </button>
        <button class="btn btn-secondary" onclick="savePositions()">
          üíæ Sauvegarder positions
        </button>
      </div>

      <div class="form-section">
        <h2 class="section-title">Envoi Discord</h2>
        <button class="btn btn-primary" onclick="sendToDiscord()" style="background:linear-gradient(135deg, #5865F2 0%, #4752C4 100%);">
          üì§ Envoyer cette facture
        </button>
        <button class="btn btn-secondary" onclick="sendAllInvoices()" style="background:linear-gradient(135deg, #7289DA 0%, #5B6EAE 100%);border:none;margin-top:0.5rem;">
          üì§ Envoyer toutes les factures (Sheet)
        </button>
        <div id="discordStatus" style="margin-top:0.8rem;padding:0.8rem;background:rgba(212,175,55,0.1);border-radius:8px;text-align:center;font-size:0.85rem;color:var(--color-gold);display:none;">
          ‚è≥ En cours d'envoi...
        </div>
        <div style="margin-top:0.8rem;font-size:0.8rem;color:var(--color-text-dim);text-align:center;">
          üí° Le webhook Discord est r√©cup√©r√© depuis la colonne C du Sheet
        </div>
      </div>

      <div class="form-section">
        <h2 class="section-title">Gestion des factures</h2>
        <button class="btn btn-primary" onclick="incrementInvoiceNumber()">
          üÜï Nouvelle facture (N¬∞ suivant)
        </button>
        <button class="btn btn-secondary" onclick="resetInvoiceCounter()" style="background:rgba(255,68,68,0.2);border-color:#ff4444;color:#ff4444;">
          üîÑ R√©initialiser compteur
        </button>
        <div class="invoice-number-badge">
          üìã Num√©ro actuel : <strong id="currentInvoiceNumber">F2601-0239</strong>
        </div>
      </div>

      <div class="help-text">
        <strong>üí° Astuces :</strong><br>
        ‚Ä¢ Le <strong>compte</strong> se remplit automatiquement selon l'entreprise<br>
        ‚Ä¢ L'aper√ßu se met √† jour <strong>en temps r√©el</strong><br>
        ‚Ä¢ Clic droit sur les √©l√©ments pour les aligner<br>
        ‚Ä¢ Fl√®ches clavier pour d√©placer (Shift = rapide)
      </div>
    </div>

    <!-- Panneau d'aper√ßu -->
    <div class="preview-panel">

      <div id="invoice-preview-wrap">
        <div id="invoice">
          <div class="invoice-bg" id="invoiceBg"></div>

          <div class="draggable" id="txtNumeroFacture" style="left:50px;top:50px;"><span>F2601-0239</span></div>
          <div class="draggable" id="txtDate" style="left:50px;top:100px;"><span>06/01/2026</span></div>
          <div class="draggable" id="txtEntreprise" style="left:50px;top:150px;"><span>Entreprise</span></div>
          <div class="draggable" id="txtCompte" style="left:50px;top:200px;"><span>Compte</span></div>
          <div class="draggable" id="txtContrat" style="left:50px;top:250px;"><span>Contrat</span></div>
          <div class="draggable" id="txtRaison" style="left:50px;top:350px;"><span>Raison</span></div>
          <div class="draggable" id="txtQuantite" style="left:400px;top:350px;"><span>Qt√©</span></div>
          <div class="draggable" id="txtPrix" style="left:500px;top:350px;"><span>Prix</span></div>
          <div class="draggable" id="txtTotal" style="left:600px;top:800px;"><span>Total: 0$</span></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de chargement -->
<div id="loadingModal" class="modal">
  <div class="modal-content">
    <h2>‚è≥ G√©n√©ration en cours...</h2>
    <div class="spinner"></div>
    <p>Veuillez patienter pendant la cr√©ation de votre facture</p>
  </div>
</div>

<script>
/* ========================================
   üìä CONFIGURATION GOOGLE SHEETS
   ======================================== */

// ‚öôÔ∏è IMPORTANT : Remplacez par l'ID de votre Google Sheet
const SPREADSHEET_ID = '19YnTEHpGQSoqMbInvK29HWsPBXzoexYcqzRVDJjKsyI';
const SHEET_NAME = 'Info facture';

// üîë Cl√© API Google (vous devez cr√©er une dans Google Cloud Console)
// Instructions : https://developers.google.com/sheets/api/quickstart/js
const API_KEY = 'AIzaSyDQzvChjm5Qx6iM4s_al4Qpy9ameiGlubQ'; // √Ä remplacer !

/* ========================================
   üîß CODE FONCTIONNEL
   ======================================== */


let selectedEl = null;
let sheetData = {
  entreprises: {},
  contrats: [],
  fullData: [] // Stocker toutes les donn√©es compl√®tes des lignes
};

function px(n) { return (Math.round(n)) + 'px'; }

function showModal() {
  document.getElementById('loadingModal').style.display = 'flex';
}

function hideModal() {
  document.getElementById('loadingModal').style.display = 'none';
}

function showNotification(message, type = 'success') {
  const notif = document.createElement('div');
  const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ö†Ô∏è';
  notif.textContent = `${icon} ${message}`;
  
  // Styling selon le th√®me
  const isDark = document.documentElement.getAttribute('data-theme') !== 'light';
  
  let bgColor, textColor;
  if (type === 'error') {
    bgColor = 'rgba(239, 68, 68, 0.95)';
    textColor = '#ffffff';
  } else if (type === 'warning') {
    bgColor = isDark ? 'rgba(212, 175, 55, 0.95)' : 'rgba(245, 158, 11, 0.95)';
    textColor = '#ffffff';
  } else {
    bgColor = isDark ? 'rgba(233, 69, 96, 0.95)' : 'rgba(99, 102, 241, 0.95)';
    textColor = '#ffffff';
  }
  
  notif.style.cssText = `
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: ${bgColor};
    padding: 1.2rem 2rem;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    backdrop-filter: blur(10px);
    z-index: 9999;
    color: ${textColor};
    font-weight: 600;
    font-size: 1rem;
    animation: slideInRight 0.4s ease;
    border: 1px solid rgba(255,255,255,0.2);
    max-width: 400px;
  `;
  document.body.appendChild(notif);
  setTimeout(() => {
    notif.style.animation = 'slideOutRight 0.4s ease';
    setTimeout(() => notif.remove(), 400);
  }, 3000);
}

// Ajouter les animations CSS si elles n'existent pas
if (!document.getElementById('notification-styles')) {
  const style = document.createElement('style');
  style.id = 'notification-styles';
  style.textContent = `
    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  `;
  document.head.appendChild(style);
}

/* ---------- Google Sheets API ---------- */
async function loadGoogleSheetsData() {
  // V√©rifier si la cl√© API est configur√©e
  if (API_KEY === 'VOTRE_CLE_API_ICI') {
    console.warn('‚ö†Ô∏è Cl√© API non configur√©e - utilisation des donn√©es de test');
    showNotification('Mode d√©mo : configurez votre cl√© API pour charger vos donn√©es', 'warning');
    
    // Donn√©es de test
    sheetData.entreprises = {
      "Paleto Garage": "123456789",
      "Los Santos Customs": "987654321",
      "Bennys Original": "456789123"
    };
    sheetData.contrats = ["Maintenance", "R√©paration", "Service"];
    
    document.getElementById('configBanner').style.display = 'block';
    return;
  }

  try {
    // Cacher la banni√®re si configur√©
    document.getElementById('configBanner').style.display = 'none';
    
    // URL de l'API Google Sheets - R√©cup√©rer colonnes A √† G
    const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}!A2:G?key=${API_KEY}`;
    
    const response = await fetch(url);
    
    if (!response.ok) {
      throw new Error(`Erreur API: ${response.status}`);
    }
    
    const data = await response.json();
    const rows = data.values || [];
    
    // Parser les donn√©es
    const entreprisesMap = {};
    const contratsSet = new Set();
    const fullDataArray = [];
    
    rows.forEach(row => {
      // Colonnes: A=details, B=typeContrat, C=webhook, D=entreprise, E=compte, F=montant, G=contrat(2)
      const details = row[0] || '';
      const typeContrat = row[1] || '';
      const webhook = row[2] || '';
      const entreprise = row[3] || '';
      const compte = row[4] || '';
      const montant = row[5] || '';
      const contrat = row[6] || '';
      
      // Stocker les donn√©es compl√®tes
      if (entreprise) {
        fullDataArray.push({
          details: details,
          typeContrat: typeContrat,
          webhook: webhook,
          entreprise: entreprise,
          compte: compte,
          montant: montant,
          contrat: contrat
        });
      }
      
      // Map entreprise -> compte
      if (entreprise && compte) {
        entreprisesMap[entreprise] = compte;
      }
      
      // Collecter les contrats uniques
      if (typeContrat) {
        contratsSet.add(typeContrat);
      }
      if (contrat) {
        contratsSet.add(contrat);
      }
    });
    
    sheetData.entreprises = entreprisesMap;
    sheetData.contrats = Array.from(contratsSet);
    sheetData.fullData = fullDataArray;
    
    console.log('‚úÖ Donn√©es charg√©es:', 
      Object.keys(sheetData.entreprises).length, 'entreprises,',
      sheetData.contrats.length, 'contrats'
    );
    
    showNotification(`Donn√©es charg√©es: ${Object.keys(sheetData.entreprises).length} entreprises`);
    
  } catch (error) {
    console.error('‚ùå Erreur lors du chargement des donn√©es:', error);
    showNotification('Erreur de chargement des donn√©es - v√©rifiez la configuration', 'error');
    
    // Fallback sur donn√©es de test
    sheetData.entreprises = {
      "Paleto Garage": "123456789",
      "Los Santos Customs": "987654321"
    };
    sheetData.contrats = ["Maintenance", "R√©paration"];
  }
}

/* ---------- Autocomplete avec donn√©es Google Sheets ---------- */
function setupAutocomplete(inputId) {
  const input = document.getElementById(inputId);
  const listId = inputId + 'List';
  const listContainer = document.getElementById(listId);

  input.addEventListener('input', () => {
    const value = input.value.toLowerCase().trim();
    listContainer.innerHTML = '';
    
    if (!value) {
      listContainer.style.display = 'none';
      return;
    }

    let filtered = [];
    
    if (inputId === 'entreprise') {
      filtered = Object.keys(sheetData.entreprises).filter(item => 
        item.toLowerCase().includes(value)
      );
    } else if (inputId === 'compte') {
      filtered = Object.values(sheetData.entreprises).filter(item => 
        item.toLowerCase().includes(value)
      );
    } else if (inputId === 'contrat') {
      filtered = sheetData.contrats.filter(item => 
        item.toLowerCase().includes(value)
      );
    }

    if (filtered.length === 0) {
      listContainer.style.display = 'none';
      return;
    }

    filtered.forEach(item => {
      const div = document.createElement('div');
      div.textContent = item;
      div.addEventListener('click', () => {
        input.value = item;
        listContainer.style.display = 'none';
        
        if (inputId === 'entreprise') {
          handleEntrepriseChange();
        }
      });
      listContainer.appendChild(div);
    });

    listContainer.style.display = 'block';
  });

  document.addEventListener('click', (e) => {
    if (!input.contains(e.target) && !listContainer.contains(e.target)) {
      listContainer.style.display = 'none';
    }
  });
  
  // Mise √† jour en temps r√©el quand on tape
  input.addEventListener('input', renderPreview);
}

/* ---------- Remplissage automatique du compte ---------- */
function handleEntrepriseChange() {
  const entreprise = document.getElementById('entreprise').value.trim();
  const compteInput = document.getElementById('compte');
  const badge = document.getElementById('compteAutoFill');
  
  if (entreprise && sheetData.entreprises[entreprise]) {
    compteInput.value = sheetData.entreprises[entreprise];
    badge.style.display = 'inline';
    showNotification('Compte rempli automatiquement !');
    setTimeout(() => {
      badge.style.display = 'none';
    }, 3000);
    
    // Mise √† jour de l'aper√ßu
    renderPreview();
  }
}

/* ---------- Reasons form ---------- */
function addReason(description = "", quantite = 1, prix = 0) {
  const container = document.getElementById("reasons-container");
  const line = document.createElement("div");
  line.className = "reason-line";

  const descInput = document.createElement("input");
  descInput.type = "text";
  descInput.placeholder = "Description";
  descInput.value = description;
  descInput.className = "custom-input reason-desc";

  const qtyInput = document.createElement("input");
  qtyInput.type = "number";
  qtyInput.min = 1;
  qtyInput.value = quantite;
  qtyInput.className = "custom-input reason-qty";
  qtyInput.placeholder = "Qt√©";

  const priceInput = document.createElement("input");
  priceInput.type = "number";
  priceInput.step = 0.01;
  priceInput.value = prix;
  priceInput.className = "custom-input reason-price";
  priceInput.placeholder = "Prix";

  const removeBtn = document.createElement("button");
  removeBtn.type = "button";
  removeBtn.className = "btn btn-icon btn-remove";
  removeBtn.textContent = "‚úï";
  removeBtn.onclick = () => {
    line.remove();
    renderPreview(); // Mise √† jour apr√®s suppression
  };

  // Ajouter des listeners pour mise √† jour temps r√©el
  descInput.addEventListener('input', renderPreview);
  qtyInput.addEventListener('input', renderPreview);
  priceInput.addEventListener('input', renderPreview);

  line.appendChild(descInput);
  line.appendChild(qtyInput);
  line.appendChild(priceInput);
  line.appendChild(removeBtn);
  container.appendChild(line);
  
  // Mise √† jour apr√®s ajout
  renderPreview();
}

/* ---------- Gestion du num√©ro de facture ---------- */
function generateInvoiceNumber() {
  // R√©cup√©rer le compteur actuel depuis localStorage
  let invoiceCounter = parseInt(localStorage.getItem('invoice_counter') || '239');
  
  // Obtenir l'ann√©e et le mois actuels
  const now = new Date();
  const year = now.getFullYear().toString().slice(-2); // 2026 -> 26
  const month = (now.getMonth() + 1).toString().padStart(2, '0'); // 01-12
  
  // Formater le compteur sur 4 chiffres
  const counterStr = invoiceCounter.toString().padStart(4, '0');
  
  // G√©n√©rer le num√©ro: F2601-0239
  return `F${year}${month}-${counterStr}`;
}

function generateNextInvoiceNumber() {
  // Incr√©menter d'abord
  let invoiceCounter = parseInt(localStorage.getItem('invoice_counter') || '239');
  invoiceCounter++;
  localStorage.setItem('invoice_counter', invoiceCounter.toString());
  
  // Obtenir l'ann√©e et le mois actuels
  const now = new Date();
  const year = now.getFullYear().toString().slice(-2);
  const month = (now.getMonth() + 1).toString().padStart(2, '0');
  
  // Formater le compteur sur 4 chiffres
  const counterStr = invoiceCounter.toString().padStart(4, '0');
  
  // Retourner le num√©ro avec le nouveau compteur
  return `F${year}${month}-${counterStr}`;
}

function incrementInvoiceNumber() {
  // Incr√©menter le compteur
  let invoiceCounter = parseInt(localStorage.getItem('invoice_counter') || '239');
  invoiceCounter++;
  localStorage.setItem('invoice_counter', invoiceCounter.toString());
  
  // Mettre √† jour l'affichage
  updateInvoiceNumber();
  document.getElementById('currentInvoiceNumber').textContent = generateInvoiceNumber();
  showNotification(`Nouvelle facture : ${generateInvoiceNumber()}`);
}

function updateInvoiceNumber() {
  const txtNumeroFacture = document.getElementById('txtNumeroFacture').querySelector('span');
  txtNumeroFacture.textContent = generateInvoiceNumber();
  
  // Mettre √† jour aussi le badge si l'√©l√©ment existe
  const badge = document.getElementById('currentInvoiceNumber');
  if (badge) {
    badge.textContent = generateInvoiceNumber();
  }
}

function resetInvoiceCounter() {
  if (confirm('Voulez-vous vraiment r√©initialiser le compteur de factures √† 0 ?')) {
    localStorage.setItem('invoice_counter', '0');
    updateInvoiceNumber();
    showNotification('Compteur r√©initialis√© √† 0');
  }
}

/* ---------- Render preview ---------- */
function renderPreview() {
  const entreprise = document.getElementById('entreprise').value;
  const compte = document.getElementById('compte').value;
  const contrat = document.getElementById('contrat').value;
  const date = new Date().toLocaleDateString('fr-FR');

  const txtDate = document.getElementById('txtDate').querySelector('span');
  const txtNumeroFacture = document.getElementById('txtNumeroFacture').querySelector('span');
  const txtEntreprise = document.getElementById('txtEntreprise').querySelector('span');
  const txtCompte = document.getElementById('txtCompte').querySelector('span');
  const txtContrat = document.getElementById('txtContrat').querySelector('span');
  const txtRaison = document.getElementById('txtRaison').querySelector('span');
  const txtQuantite = document.getElementById('txtQuantite').querySelector('span');
  const txtPrix = document.getElementById('txtPrix').querySelector('span');
  const txtTotal = document.getElementById('txtTotal').querySelector('span');

  txtRaison.textContent = '';
  txtQuantite.textContent = '';
  txtPrix.textContent = '';

  let totalGlobal = 0;
  document.querySelectorAll('.reason-line').forEach(line => {
    const desc = line.querySelector('.reason-desc').value || '';
    const qte = parseFloat(line.querySelector('.reason-qty').value) || 0;
    const prix = parseFloat(line.querySelector('.reason-price').value) || 0;
    const totalLigne = qte * prix;
    totalGlobal += totalLigne;

    txtRaison.textContent += desc + '\n';
    txtQuantite.textContent += qte + '\n';
    txtPrix.textContent += prix.toFixed(0) + '$\n';
  });

  txtDate.textContent = "Date : " + date;
  txtNumeroFacture.textContent = generateInvoiceNumber();
  txtEntreprise.textContent = "Entreprise: " + entreprise;
  txtCompte.textContent = "Compte : " + compte;
  txtContrat.textContent = contrat;
  txtTotal.textContent = totalGlobal.toFixed(0) + "$";
}

/* ---------- Position save/load ---------- */
function savePositions() {
  const wrap = document.getElementById('invoice-preview-wrap');
  const wrapRect = wrap.getBoundingClientRect();
  const positions = {};
  
  document.querySelectorAll('.draggable').forEach(el => {
    const rect = el.getBoundingClientRect();
    const left = el.style.left && el.style.left !== '' ? el.style.left : px(rect.left - wrapRect.left);
    const top = el.style.top && el.style.top !== '' ? el.style.top : px(rect.top - wrapRect.top);
    const align = el.style.textAlign && el.style.textAlign !== '' ? el.style.textAlign : getComputedStyle(el).textAlign || 'left';

    positions[el.id] = { left: left, top: top, textAlign: align };
  });

  localStorage.setItem('invoice_positions', JSON.stringify(positions));
  showNotification('Positions sauvegard√©es !');
}

function loadPositions() {
  const s = localStorage.getItem('invoice_positions');
  if (!s) return;
  
  const positions = JSON.parse(s);
  for (const id in positions) {
    const el = document.getElementById(id);
    if (!el) continue;
    const p = positions[id];
    el.style.left = typeof p.left === 'number' ? px(p.left) : (p.left || '0px');
    el.style.top = typeof p.top === 'number' ? px(p.top) : (p.top || '0px');
    el.style.textAlign = p.textAlign || 'left';
    const span = el.querySelector('span');
    if (span) span.style.textAlign = p.textAlign || 'left';
  }
}

/* ---------- Draggable with snap ---------- */
function makeDraggable() {
  const SNAP_DISTANCE = 6;
  const wrap = document.getElementById('invoice-preview-wrap');

  document.querySelectorAll('.draggable').forEach(el => {
    if (!el.style.left || !el.style.top) {
      const rect = el.getBoundingClientRect();
      const wrapRect = wrap.getBoundingClientRect();
      el.style.left = px(rect.left - wrapRect.left);
      el.style.top = px(rect.top - wrapRect.top);
    }

    let isDragging = false;
    let offsetX = 0, offsetY = 0;
    let pointerId = null;

    function startDrag(e) {
      isDragging = true;
      pointerId = e.pointerId;
      el.setPointerCapture(pointerId);
      const rect = el.getBoundingClientRect();
      offsetX = e.clientX - rect.left;
      offsetY = e.clientY - rect.top;
      selectedEl = el;
      document.querySelectorAll('.draggable').forEach(d => d.classList.remove('selected'));
      el.classList.add('selected');
    }

    function moveDrag(e) {
      if (!isDragging) return;
      const wrapRect = wrap.getBoundingClientRect();
      const elRect = el.getBoundingClientRect();
      let x = e.clientX - wrapRect.left - offsetX;
      let y = e.clientY - wrapRect.top - offsetY;

      document.querySelectorAll('.draggable').forEach(other => {
        if (other === el) return;
        const oRect = other.getBoundingClientRect();
        if (Math.abs((oRect.left - wrapRect.left) - x) < SNAP_DISTANCE) x = oRect.left - wrapRect.left;
        if (Math.abs((oRect.right - wrapRect.left) - (x + elRect.width)) < SNAP_DISTANCE) x = oRect.right - wrapRect.left - elRect.width;
        const oCenterX = (oRect.left + oRect.width / 2) - wrapRect.left;
        const eCenterX = x + elRect.width / 2;
        if (Math.abs(oCenterX - eCenterX) < SNAP_DISTANCE) x = oCenterX - elRect.width / 2;

        if (Math.abs((oRect.top - wrapRect.top) - y) < SNAP_DISTANCE) y = oRect.top - wrapRect.top;
        if (Math.abs((oRect.bottom - wrapRect.top) - (y + elRect.height)) < SNAP_DISTANCE) y = oRect.bottom - wrapRect.top - elRect.height;
        const oCenterY = (oRect.top + oRect.height / 2) - wrapRect.top;
        const eCenterY = y + elRect.height / 2;
        if (Math.abs(oCenterY - eCenterY) < SNAP_DISTANCE) y = oCenterY - elRect.height / 2;
      });

      el.style.left = px(Math.max(0, Math.round(x)));
      el.style.top = px(Math.max(0, Math.round(y)));
    }

    function stopDrag(e) {
      if (!isDragging) return;
      isDragging = false;
      try { el.releasePointerCapture(pointerId); } catch (e) { }
      pointerId = null;
    }

    el.addEventListener('pointerdown', startDrag);
    el.addEventListener('pointermove', moveDrag);
    document.addEventListener('pointerup', stopDrag);
    document.addEventListener('pointercancel', stopDrag);
    el.addEventListener('dragstart', e => e.preventDefault());
  });
}

/* ---------- Context menu ---------- */
const contextMenu = document.createElement('div');
contextMenu.className = 'context-menu';
contextMenu.innerHTML = `
  <div data-action="align-left">‚¨ÖÔ∏è Aligner √† gauche</div>
  <div data-action="align-center">üîπ Centrer</div>
  <div data-action="align-right">‚û°Ô∏è Aligner √† droite</div>
  <div data-action="align-wider">‚§¥Ô∏è Allonger le bloc</div>
  <div data-action="narrower">‚§µÔ∏è R√©duire le bloc</div>
`;
document.body.appendChild(contextMenu);

document.addEventListener('contextmenu', e => {
  if (e.target.closest('.draggable')) {
    e.preventDefault();
    selectedEl = e.target.closest('.draggable');
    document.querySelectorAll('.draggable').forEach(d => d.classList.remove('selected'));
    selectedEl.classList.add('selected');
    contextMenu.style.display = 'block';
    contextMenu.style.left = e.pageX + 'px';
    contextMenu.style.top = e.pageY + 'px';
  } else {
    contextMenu.style.display = 'none';
  }
});

contextMenu.addEventListener('click', e => {
  if (!selectedEl) return;
  const action = e.target.getAttribute('data-action');
  switch (action) {
    case 'align-left':
      selectedEl.style.textAlign = 'left';
      break;
    case 'align-center':
      selectedEl.style.textAlign = 'center';
      break;
    case 'align-right':
      selectedEl.style.textAlign = 'right';
      break;
    case 'wider':
      selectedEl.style.minWidth = (parseInt(getComputedStyle(selectedEl).minWidth || '120') + 20) + 'px';
      break;
    case 'narrower':
      selectedEl.style.minWidth = Math.max(60, parseInt(getComputedStyle(selectedEl).minWidth || '120') - 20) + 'px';
      break;
  }
  contextMenu.style.display = 'none';
});

document.addEventListener('click', e => {
  if (!contextMenu.contains(e.target)) contextMenu.style.display = 'none';
  const d = e.target.closest('.draggable');
  if (d) {
    selectedEl = d;
    document.querySelectorAll('.draggable').forEach(x => x.classList.remove('selected'));
    d.classList.add('selected');
  }
});

/* ---------- Keyboard nudging ---------- */
document.addEventListener('keydown', e => {
  if (!selectedEl) return;
  const step = e.shiftKey ? 10 : 1;
  const left = parseInt(selectedEl.style.left || 0);
  const top = parseInt(selectedEl.style.top || 0);
  switch (e.key) {
    case 'ArrowUp':
      e.preventDefault();
      selectedEl.style.top = px(top - step);
      break;
    case 'ArrowDown':
      e.preventDefault();
      selectedEl.style.top = px(top + step);
      break;
    case 'ArrowLeft':
      e.preventDefault();
      selectedEl.style.left = px(left - step);
      break;
    case 'ArrowRight':
      e.preventDefault();
      selectedEl.style.left = px(left + step);
      break;
    default:
      return;
  }
});

/* ---------- Download as Image (Canvas Method) ---------- */
async function downloadInvoiceImage() {
  showModal();

  try {
    // G√©n√©rer le PROCHAIN num√©ro de facture et incr√©menter
    const newNumeroFacture = generateNextInvoiceNumber();
    
    // Mettre √† jour l'aper√ßu avec ce nouveau num√©ro
    const txtNumeroFacture = document.getElementById('txtNumeroFacture');
    if (txtNumeroFacture) {
      const span = txtNumeroFacture.querySelector('span');
      if (span) {
        span.textContent = newNumeroFacture;
      }
    }
    
    // Mettre √† jour le badge
    const badge = document.getElementById('currentInvoiceNumber');
    if (badge) {
      badge.textContent = generateInvoiceNumber();
    }
    
    const canvas = document.createElement('canvas');
    canvas.width = 794;
    canvas.height = 1123;
    const ctx = canvas.getContext('2d');

    const bgImg = new Image();
    bgImg.crossOrigin = "anonymous";
    bgImg.src = "https://firstartonn.github.io/facturetest/Facture%20Paleto%20Garage%20(63).png";
    
    await new Promise((resolve, reject) => {
      bgImg.onload = resolve;
      bgImg.onerror = reject;
    });

    ctx.drawImage(bgImg, 0, 0, 794, 1123);

    document.querySelectorAll('.draggable').forEach(el => {
      const span = el.querySelector('span');
      if (!span) return;

      const text = span.textContent;
      const x = parseInt(el.style.left || 0);
      const y = parseInt(el.style.top || 0);
      
      // Debug: afficher les positions
      if (el.id === 'txtNumeroFacture') {
        console.log(`üìç Position ${el.id}:`, { x, y, styleLeft: el.style.left, styleTop: el.style.top });
      }
      
      // Gestion sp√©ciale pour le num√©ro de facture (Roboto 31.8px)
      let fontSize, fontFamily, fontWeight;
      if (el.id === 'txtNumeroFacture') {
        fontSize = 31.8;
        fontFamily = 'Roboto';
        fontWeight = '700';
      } else {
        fontSize = parseInt(getComputedStyle(el).fontSize || '16');
        fontFamily = 'Arial';
        fontWeight = getComputedStyle(el).fontWeight || '500';
      }
      
      const align = el.style.textAlign || 'left';

      ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}, sans-serif`;
      ctx.fillStyle = '#111';
      ctx.textAlign = align;

      const lines = text.split('\n');
      lines.forEach((line, index) => {
        const lineY = y + (index * (fontSize + 4)) + fontSize;
        let lineX = x;
        
        if (align === 'center') {
          const width = parseInt(getComputedStyle(el).minWidth || '120');
          lineX = x + width / 2;
        } else if (align === 'right') {
          const width = parseInt(getComputedStyle(el).minWidth || '120');
          lineX = x + width;
        }
        
        ctx.fillText(line, lineX, lineY);
      });
    });

    canvas.toBlob(blob => {
      hideModal();
      
      if (!blob) {
        showNotification('Erreur lors de la g√©n√©ration', 'error');
        return;
      }

      const fileName = 'facture_' + new Date().toISOString().slice(0, 10) + '.png';
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = fileName;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);
      
      showNotification('Facture t√©l√©charg√©e avec succ√®s !');
    }, 'image/png');

  } catch (err) {
    hideModal();
    console.error('Erreur:', err);
    showNotification('Erreur lors de la g√©n√©ration de l\'image', 'error');
  }
}

/* ---------- Send to Discord ---------- */
async function sendToDiscord() {
  // R√©cup√©rer les donn√©es de la facture actuelle
  const entreprise = document.getElementById('entreprise').value.trim();
  const compte = document.getElementById('compte').value.trim();
  const contrat = document.getElementById('contrat').value.trim();
  
  // V√©rifier que l'entreprise est renseign√©e
  if (!entreprise) {
    showNotification('Veuillez s√©lectionner une entreprise', 'error');
    return;
  }
  
  // Chercher le webhook correspondant √† cette entreprise dans les donn√©es du Sheet
  let webhookUrl = null;
  const matchingRow = sheetData.fullData.find(row => 
    row.entreprise.toLowerCase() === entreprise.toLowerCase()
  );
  
  if (matchingRow && matchingRow.webhook) {
    webhookUrl = matchingRow.webhook;
  }
  
  // V√©rifier que le webhook est trouv√©
  if (!webhookUrl) {
    showNotification('Aucun webhook Discord trouv√© pour cette entreprise dans la colonne C du Sheet', 'error');
    return;
  }
  
  // V√©rifier que c'est une URL Discord valide
  if (!webhookUrl.includes('discord.com/api/webhooks/')) {
    showNotification('URL de webhook Discord invalide dans le Sheet (colonne C)', 'error');
    return;
  }
  
  // Afficher le statut
  const statusDiv = document.getElementById('discordStatus');
  statusDiv.style.display = 'block';
  statusDiv.innerHTML = '‚è≥ G√©n√©ration de la facture...';
  
  try {
    // G√©n√©rer le PROCHAIN num√©ro de facture et incr√©menter
    const newNumeroFacture = generateNextInvoiceNumber();
    
    // Mettre √† jour l'aper√ßu avec ce nouveau num√©ro
    const txtNumeroFacture = document.getElementById('txtNumeroFacture');
    if (txtNumeroFacture) {
      const span = txtNumeroFacture.querySelector('span');
      if (span) {
        span.textContent = newNumeroFacture;
      }
    }
    
    // Mettre √† jour le badge
    const badge = document.getElementById('currentInvoiceNumber');
    if (badge) {
      badge.textContent = generateInvoiceNumber();
    }
    
    // G√©n√©rer l'image de la facture
    const canvas = document.createElement('canvas');
    canvas.width = 794;
    canvas.height = 1123;
    const ctx = canvas.getContext('2d');

    // Charger l'image de fond
    const bgImg = new Image();
    bgImg.crossOrigin = "anonymous";
    bgImg.src = "https://firstartonn.github.io/facturetest/Facture%20Paleto%20Garage%20(63).png";
    
    await new Promise((resolve, reject) => {
      bgImg.onload = resolve;
      bgImg.onerror = reject;
    });

    // Dessiner le fond
    ctx.drawImage(bgImg, 0, 0, 794, 1123);

    // Dessiner tous les √©l√©ments de texte
    document.querySelectorAll('.draggable').forEach(el => {
      const span = el.querySelector('span');
      if (!span) return;

      const text = span.textContent;
      const x = parseInt(el.style.left || 0);
      const y = parseInt(el.style.top || 0);
      
      // Gestion sp√©ciale pour le num√©ro de facture (Roboto 31.8px)
      let fontSize, fontFamily, fontWeight;
      if (el.id === 'txtNumeroFacture') {
        fontSize = 31.8;
        fontFamily = 'Roboto';
        fontWeight = '700';
      } else {
        fontSize = parseInt(getComputedStyle(el).fontSize || '16');
        fontFamily = 'Arial';
        fontWeight = getComputedStyle(el).fontWeight || '500';
      }
      
      const align = el.style.textAlign || 'left';

      ctx.font = `${fontWeight} ${fontSize}px ${fontFamily}, sans-serif`;
      ctx.fillStyle = '#111';
      ctx.textAlign = align;

      // G√©rer le texte multiligne
      const lines = text.split('\n');
      lines.forEach((line, index) => {
        const lineY = y + (index * (fontSize + 4)) + fontSize;
        let lineX = x;
        
        if (align === 'center') {
          const width = parseInt(getComputedStyle(el).minWidth || '120');
          lineX = x + width / 2;
        } else if (align === 'right') {
          const width = parseInt(getComputedStyle(el).minWidth || '120');
          lineX = x + width;
        }
        
        ctx.fillText(line, lineX, lineY);
      });
    });

    statusDiv.innerHTML = '‚è≥ Conversion en image...';

    // Convertir le canvas en blob
    const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
    
    if (!blob) {
      throw new Error('Impossible de g√©n√©rer l\'image');
    }

    statusDiv.innerHTML = '‚è≥ Envoi sur Discord...';

    // R√©cup√©rer les donn√©es de la facture
    const entreprise = document.getElementById('entreprise').value;
    const compte = document.getElementById('compte').value;
    const contrat = document.getElementById('contrat').value;
    // Utiliser le num√©ro d√©j√† g√©n√©r√© et incr√©ment√© au d√©but de la fonction
    const numeroFacture = newNumeroFacture;
    const date = new Date().toLocaleDateString('fr-FR');
    
    // Calculer le total
    let totalGlobal = 0;
    let details = '';
    document.querySelectorAll('.reason-line').forEach(line => {
      const desc = line.querySelector('.reason-desc').value || '';
      const qte = parseFloat(line.querySelector('.reason-qty').value) || 0;
      const prix = parseFloat(line.querySelector('.reason-price').value) || 0;
      totalGlobal += qte * prix;
      if (desc) {
        details += `${desc} (${qte}x ${prix}$)\n`;
      }
    });

    // Pr√©parer le FormData pour envoyer l'image
    const formData = new FormData();
    
    // Cr√©er l'embed Discord
    const embed = {
      title: `üìã Nouvelle Facture - ${numeroFacture}`,
      color: 15158332, // Rouge/rose (#E94560)
      fields: [
        {
          name: 'üè¢ Entreprise',
          value: entreprise || 'Non sp√©cifi√©',
          inline: true
        },
        {
          name: 'üí≥ Compte',
          value: compte || 'Non sp√©cifi√©',
          inline: true
        },
        {
          name: 'üí∞ Montant Total',
          value: `**${totalGlobal.toFixed(0)}$**`,
          inline: true
        },
        {
          name: 'üìÖ Date',
          value: date,
          inline: true
        }
      ],
      image: {
        url: 'attachment://facture.png'
      },
      footer: {
        text: `Facture PaletoGarage ‚Ä¢ ${numeroFacture}`
      },
      timestamp: new Date().toISOString()
    };

    // Cr√©er le payload JSON
    const payload = {
      content: '**Paleto Garage**',
      embeds: [embed],
      username: 'Paleto Garage Facture',
      avatar_url: 'https://i.goopics.net/ije8vu.png'
    };

    // Ajouter le JSON et le fichier au FormData
    formData.append('payload_json', JSON.stringify(payload));
    formData.append('files[0]', blob, 'facture.png');

    // Envoyer √† Discord
    const response = await fetch(webhookUrl, {
      method: 'POST',
      body: formData
    });

    if (response.ok || response.status === 204) {
      statusDiv.innerHTML = '‚úÖ Facture envoy√©e avec succ√®s sur Discord !';
      statusDiv.style.background = 'rgba(87, 242, 135, 0.1)';
      statusDiv.style.color = '#57F287';
      showNotification('Facture envoy√©e sur Discord !');
      
      // Incr√©menter le compteur
      incrementInvoiceNumber();
      
      // Masquer le statut apr√®s 5 secondes
      setTimeout(() => {
        statusDiv.style.display = 'none';
        statusDiv.style.background = 'rgba(212,175,55,0.1)';
        statusDiv.style.color = 'var(--color-gold)';
      }, 5000);
    } else {
      throw new Error(`Erreur Discord: ${response.status}`);
    }

  } catch (err) {
    console.error('Erreur:', err);
    statusDiv.innerHTML = '‚ùå Erreur lors de l\'envoi: ' + err.message;
    statusDiv.style.background = 'rgba(255, 68, 68, 0.1)';
    statusDiv.style.color = '#ff4444';
    showNotification('Erreur lors de l\'envoi sur Discord', 'error');
    
    // Masquer apr√®s 5 secondes
    setTimeout(() => {
      statusDiv.style.display = 'none';
      statusDiv.style.background = 'rgba(212,175,55,0.1)';
      statusDiv.style.color = 'var(--color-gold)';
    }, 5000);
  }
}

/* ---------- Send All Invoices from Sheet ---------- */
async function sendAllInvoices() {
  // V√©rifier qu'on a des donn√©es
  if (!sheetData.fullData || sheetData.fullData.length === 0) {
    showNotification('Aucune donn√©e charg√©e depuis le Sheet', 'error');
    return;
  }
  
  // Filtrer les lignes qui ont un montant (colonne F) et un webhook (colonne C)
  const rowsToProcess = sheetData.fullData.filter(row => 
    row.montant && row.montant.toString().trim() !== '' && 
    row.webhook && row.webhook.includes('discord.com/api/webhooks/')
  );
  
  if (rowsToProcess.length === 0) {
    showNotification('Aucune facture √† envoyer (v√©rifiez colonne F pour montants et colonne C pour webhooks)', 'error');
    return;
  }
  
  // Demander confirmation
  if (!confirm(`Voulez-vous envoyer ${rowsToProcess.length} facture(s) sur Discord ?\n\nCela va g√©n√©rer et envoyer une facture pour chaque ligne du Sheet ayant un montant.`)) {
    return;
  }
  
  const statusDiv = document.getElementById('discordStatus');
  statusDiv.style.display = 'block';
  statusDiv.style.background = 'rgba(212,175,55,0.1)';
  statusDiv.style.color = 'var(--color-gold)';
  
  let successCount = 0;
  let errorCount = 0;
  
  // Traiter chaque ligne
  for (let i = 0; i < rowsToProcess.length; i++) {
    const row = rowsToProcess[i];
    
    statusDiv.innerHTML = `‚è≥ Envoi ${i + 1}/${rowsToProcess.length} : ${row.entreprise}...`;
    
    try {
      // G√©n√©rer la facture pour cette ligne
      await generateAndSendInvoiceFromRow(row);
      successCount++;
      
      // Pause de 2 secondes entre chaque envoi pour √©viter le rate limiting Discord
      if (i < rowsToProcess.length - 1) {
        await new Promise(resolve => setTimeout(resolve, 2000));
      }
      
    } catch (error) {
      console.error(`‚ùå Erreur pour ${row.entreprise}:`, error);
      console.error('D√©tails de la ligne:', row);
      console.error('Message d\'erreur:', error.message);
      console.error('Stack:', error.stack);
      errorCount++;
    }
  }
  
  // Afficher le r√©sum√©
  statusDiv.innerHTML = `‚úÖ Termin√© ! ${successCount} envoy√©es, ${errorCount} erreur(s)`;
  statusDiv.style.background = successCount > 0 ? 'rgba(87, 242, 135, 0.1)' : 'rgba(255, 68, 68, 0.1)';
  statusDiv.style.color = successCount > 0 ? '#57F287' : '#ff4444';
  
  showNotification(`Envoi termin√© : ${successCount} r√©ussie(s), ${errorCount} √©chou√©e(s)`);
  
  // Masquer apr√®s 8 secondes
  setTimeout(() => {
    statusDiv.style.display = 'none';
    statusDiv.style.background = 'rgba(212,175,55,0.1)';
    statusDiv.style.color = 'var(--color-gold)';
  }, 8000);
}

/* ---------- Generate and send invoice from a Sheet row ---------- */
async function generateAndSendInvoiceFromRow(rowData) {
  // Cr√©er le canvas
  const canvas = document.createElement('canvas');
  canvas.width = 794;
  canvas.height = 1123;
  const ctx = canvas.getContext('2d');

  // Charger l'image de fond
  const bgImg = new Image();
  bgImg.crossOrigin = "anonymous";
  bgImg.src = "https://firstartonn.github.io/facturetest/Facture%20Paleto%20Garage%20(63).png";
  
  await new Promise((resolve, reject) => {
    bgImg.onload = resolve;
    bgImg.onerror = reject;
  });

  // Dessiner le fond
  ctx.drawImage(bgImg, 0, 0, 794, 1123);

  // G√©n√©rer le PROCHAIN num√©ro de facture (incr√©mente automatiquement)
  const numeroFacture = generateNextInvoiceNumber();
  const date = new Date().toLocaleDateString('fr-FR');

  // Pr√©parer les donn√©es de la facture depuis la ligne du Sheet
  const details = rowData.details || 'Service';
  const montant = parseFloat(rowData.montant) || 0;
  
  // Positions des √©l√©ments (utilisez les positions sauvegard√©es ou par d√©faut)
  const positions = JSON.parse(localStorage.getItem('invoice_positions') || '{}');
  
  // Fonction helper pour dessiner du texte √† une position
  const drawText = (elementId, text, defaultX, defaultY, size = 16, font = 'Arial', weight = '500') => {
    const pos = positions[elementId] || { left: defaultX + 'px', top: defaultY + 'px', textAlign: 'left' };
    const x = parseInt(pos.left);
    const y = parseInt(pos.top);
    const align = pos.textAlign || 'left';
    
    // Gestion sp√©ciale pour le num√©ro de facture
    if (elementId === 'txtNumeroFacture') {
      size = 31.8;
      font = 'Roboto';
      weight = '700';
    }
    
    ctx.font = `${weight} ${size}px ${font}, sans-serif`;
    ctx.fillStyle = '#111';
    ctx.textAlign = align;
    
    // R√©cup√©rer la largeur du bloc depuis l'√©l√©ment DOM si disponible
    let width = 120; // Largeur par d√©faut
    try {
      const el = document.getElementById(elementId);
      if (el) {
        const computedWidth = parseInt(getComputedStyle(el).minWidth || '120');
        width = computedWidth;
      }
    } catch (e) {
      // Ignorer l'erreur si l'√©l√©ment n'existe pas
      console.warn(`Element ${elementId} not found, using default width`);
    }
    
    const lines = text.split('\n');
    lines.forEach((line, index) => {
      const lineY = y + (index * (size + 4)) + size;
      let lineX = x;
      
      // Calculer la position X en fonction de l'alignement
      if (align === 'center') {
        lineX = x + width / 2;
      } else if (align === 'right') {
        lineX = x + width;
      }
      
      ctx.fillText(line, lineX, lineY);
    });
  };

  // Dessiner tous les √©l√©ments de la facture
  drawText('txtNumeroFacture', numeroFacture, 50, 50);
  drawText('txtDate', `Date : ${date}`, 50, 100);
  drawText('txtEntreprise', `Entreprise: ${rowData.entreprise}`, 50, 150);
  drawText('txtCompte', `Compte : ${rowData.compte}`, 50, 200);
  drawText('txtContrat', rowData.typeContrat || rowData.contrat || '', 50, 250);
  drawText('txtRaison', details, 50, 350);
  drawText('txtQuantite', '1', 400, 350);
  drawText('txtPrix', `${montant.toFixed(0)}$`, 500, 350);
  drawText('txtTotal', `${montant.toFixed(0)}$`, 600, 800);

  // Convertir en blob
  const blob = await new Promise(resolve => canvas.toBlob(resolve, 'image/png'));
  
  if (!blob) {
    throw new Error('Impossible de g√©n√©rer l\'image');
  }

  // Pr√©parer le FormData
  const formData = new FormData();
  
  // Cr√©er l'embed Discord
  const embed = {
    title: `üìã Nouvelle Facture - ${numeroFacture}`,
    color: 15158332,
    fields: [
      {
        name: 'üè¢ Entreprise',
        value: rowData.entreprise || 'Non sp√©cifi√©',
        inline: true
      },
      {
        name: 'üí≥ Compte',
        value: rowData.compte || 'Non sp√©cifi√©',
        inline: true
      },
      {
        name: 'üí∞ Montant Total',
        value: `**${montant.toFixed(0)}$**`,
        inline: true
      },
      {
        name: 'üìÖ Date',
        value: date,
        inline: true
      }
    ],
    image: {
      url: 'attachment://facture.png'
    },
    footer: {
      text: `Facture g√©n√©r√©e automatiquement ‚Ä¢ ${numeroFacture}`
    },
    timestamp: new Date().toISOString()
  };

  // Cr√©er le payload
  const payload = {
    content: 'üîî **<@&1444800010712518676>**',
    embeds: [embed],
    username: 'Paleto Garage Facture',
    avatar_url: 'https://i.goopics.net/ije8vu.png'
  };

  formData.append('payload_json', JSON.stringify(payload));
  formData.append('files[0]', blob, 'facture.png');

  // Envoyer √† Discord
  const response = await fetch(rowData.webhook, {
    method: 'POST',
    body: formData
  });

  if (!response.ok && response.status !== 204) {
    throw new Error(`Erreur Discord: ${response.status}`);
  }

  // Le compteur a d√©j√† √©t√© incr√©ment√© dans generateNextInvoiceNumber()
  // Mettre √† jour l'affichage du badge
  const badge = document.getElementById('currentInvoiceNumber');
  if (badge) {
    badge.textContent = generateInvoiceNumber();
  }
  
  // Mettre √† jour l'aper√ßu avec le nouveau num√©ro
  const txtNumeroFacture = document.getElementById('txtNumeroFacture');
  if (txtNumeroFacture) {
    const span = txtNumeroFacture.querySelector('span');
    if (span) {
      span.textContent = generateInvoiceNumber();
    }
  }
  
  return true;
}

/* ---------- Theme Toggle ---------- */
function toggleTheme() {
  const html = document.documentElement;
  const currentTheme = html.getAttribute('data-theme');
  const newTheme = currentTheme === 'light' ? 'dark' : 'light';
  
  html.setAttribute('data-theme', newTheme);
  localStorage.setItem('invoice-theme', newTheme);
  
  const icon = document.getElementById('themeIcon');
  if (icon) {
    icon.textContent = newTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
  }
}

function loadTheme() {
  const savedTheme = localStorage.getItem('invoice-theme') || 'dark';
  document.documentElement.setAttribute('data-theme', savedTheme);
  const icon = document.getElementById('themeIcon');
  if (icon) {
    icon.textContent = savedTheme === 'light' ? '‚òÄÔ∏è' : 'üåô';
  }
}

/* ---------- Init ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  // Charger le th√®me sauvegard√©
  loadTheme();
  
  if (!document.querySelectorAll('.reason-line').length) addReason();
  
  // Charger les donn√©es depuis Google Sheets
  await loadGoogleSheetsData();
  
  // Initialiser l'autocompl√©tion
  setupAutocomplete('entreprise');
  setupAutocomplete('compte');
  setupAutocomplete('contrat');
  
  // Auto-fill sur blur/enter
  const entrepriseInput = document.getElementById('entreprise');
  entrepriseInput.addEventListener('blur', handleEntrepriseChange);
  entrepriseInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      handleEntrepriseChange();
    }
  });
  
  makeDraggable();
  loadPositions();
  
  // Initialiser le num√©ro de facture
  updateInvoiceNumber();
  
  // Rendu initial
  renderPreview();
  
  console.log('‚úÖ G√©n√©rateur de factures charg√©!');
});
</script>
</body>
</html>
